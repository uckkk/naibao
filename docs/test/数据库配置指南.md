# 数据库配置指南

## 📋 前置要求

- PostgreSQL 15+ 已安装（或使用腾讯云轻量数据库）
- Redis 7+ 已安装（用于缓存和会话）

## 💡 推荐方案

**腾讯云轻量数据库 PostgreSQL版** - 性价比最高
- 价格：¥35/月（¥168/年）
- 配置：1核1G/20GB SSD
- 性能：支持0-1万用户
- 延时：内网<5ms

详细选型建议请查看：[腾讯云数据库选型建议](../tech/腾讯云数据库选型建议.md)

---

## 🗄️ 一、PostgreSQL 数据库配置

### 1.1 安装 PostgreSQL

#### macOS
```bash
# 使用 Homebrew 安装
brew install postgresql@15

# 启动服务
brew services start postgresql@15
```

#### Linux (Ubuntu/Debian)
```bash
sudo apt update
sudo apt install postgresql-15

# 启动服务
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

#### Windows
从 [PostgreSQL官网](https://www.postgresql.org/download/windows/) 下载安装程序

---

### 1.2 创建数据库

```bash
# 连接到 PostgreSQL
psql -U postgres

# 创建数据库
CREATE DATABASE naibao;

# 设置数据库编码（推荐）
ALTER DATABASE naibao SET encoding = 'UTF8';

# 退出
\q
```

---

### 1.3 创建数据库用户（可选，推荐）

```bash
# 连接到 PostgreSQL
psql -U postgres

# 创建用户
CREATE USER naibao_user WITH PASSWORD 'your_password_here';

# 授予权限
GRANT ALL PRIVILEGES ON DATABASE naibao TO naibao_user;

# 如果使用 PostgreSQL 15+，还需要授予 schema 权限
\c naibao
GRANT ALL ON SCHEMA public TO naibao_user;

# 退出
\q
```

---

### 1.4 初始化数据库表结构

```bash
# 方式1：使用 psql 命令
psql -U postgres -d naibao -f database/schema.sql

# 方式2：如果创建了专用用户
psql -U naibao_user -d naibao -f database/schema.sql

# 方式3：在 psql 中执行
psql -U postgres -d naibao
\i database/schema.sql
\q
```

---

### 1.5 导入初始化数据

```bash
# 导入卫健委标准数据等初始化数据
psql -U postgres -d naibao -f database/init_data.sql

# 或在 psql 中执行
psql -U postgres -d naibao
\i database/init_data.sql
\q
```

---

### 1.6 验证数据库

```bash
# 连接到数据库
psql -U postgres -d naibao

# 查看所有表
\dt

# 查看 health_standards 表数据（验证初始化数据）
SELECT * FROM health_standards LIMIT 5;

# 查看 formula_brands 表数据
SELECT * FROM formula_brands LIMIT 5;

# 退出
\q
```

---

## 🔧 二、后端环境变量配置

### 2.1 创建环境变量文件

在 `backend/` 目录下创建 `.env` 文件：

```bash
cd backend
touch .env
```

### 2.2 配置数据库连接信息

编辑 `backend/.env` 文件：

```env
# 服务器配置
SERVER_PORT=8080
GIN_MODE=debug

# 数据库配置（使用默认 postgres 用户）
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=your_postgres_password
DB_NAME=naibao
DB_SSLMODE=disable

# 或者使用专用用户
# DB_USER=naibao_user
# DB_PASSWORD=your_password_here

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT配置
JWT_SECRET=your-secret-key-change-in-production
```

---

### 2.3 修改后端代码支持 .env 文件（可选）

如果使用 `.env` 文件，需要安装 `godotenv` 包：

```bash
cd backend
go get github.com/joho/godotenv
```

修改 `backend/config/config.go`：

```go
package config

import (
	"os"
	"github.com/joho/godotenv"
)

func Load() *Config {
	// 加载 .env 文件
	godotenv.Load()
	
	return &Config{
		// ... 其余代码不变
	}
}
```

---

### 2.4 或者直接使用环境变量

不创建 `.env` 文件，直接在系统中设置环境变量：

#### macOS/Linux
```bash
export DB_HOST=localhost
export DB_PORT=5432
export DB_USER=postgres
export DB_PASSWORD=your_password
export DB_NAME=naibao
export DB_SSLMODE=disable

export REDIS_HOST=localhost
export REDIS_PORT=6379

export JWT_SECRET=your-secret-key
```

#### Windows (PowerShell)
```powershell
$env:DB_HOST="localhost"
$env:DB_PORT="5432"
$env:DB_USER="postgres"
$env:DB_PASSWORD="your_password"
$env:DB_NAME="naibao"
$env:DB_SSLMODE="disable"

$env:REDIS_HOST="localhost"
$env:REDIS_PORT="6379"

$env:JWT_SECRET="your-secret-key"
```

---

## 📦 三、Redis 配置（缓存和会话）

### 3.1 安装 Redis

#### macOS
```bash
brew install redis
brew services start redis
```

#### Linux (Ubuntu/Debian)
```bash
sudo apt install redis-server
sudo systemctl start redis
sudo systemctl enable redis
```

#### Windows
从 [Redis官网](https://redis.io/download) 下载或使用 WSL

---

### 3.2 验证 Redis

```bash
# 测试连接
redis-cli ping
# 应该返回: PONG

# 测试设置和获取
redis-cli set test "hello"
redis-cli get test
# 应该返回: "hello"
```

---

## 🧪 四、测试数据库连接

### 4.1 测试 PostgreSQL 连接

创建测试文件 `backend/test_db.go`：

```go
package main

import (
	"fmt"
	"naibao-backend/config"
	"naibao-backend/database"
)

func main() {
	cfg := config.Load()
	
	db, err := database.InitDB(cfg.Database)
	if err != nil {
		fmt.Printf("❌ 数据库连接失败: %v\n", err)
		return
	}
	
	fmt.Println("✅ 数据库连接成功!")
	
	// 测试查询
	var count int64
	db.Raw("SELECT COUNT(*) FROM health_standards").Scan(&count)
	fmt.Printf("✅ health_standards 表记录数: %d\n", count)
}
```

运行测试：
```bash
cd backend
go run test_db.go
```

---

### 4.2 测试 Redis 连接

创建测试文件 `backend/test_redis.go`：

```go
package main

import (
	"context"
	"fmt"
	"naibao-backend/config"
	"naibao-backend/database"
)

func main() {
	cfg := config.Load()
	
	rdb, err := database.InitRedis(cfg.Redis)
	if err != nil {
		fmt.Printf("❌ Redis连接失败: %v\n", err)
		return
	}
	
	fmt.Println("✅ Redis连接成功!")
	
	// 测试设置和获取
	ctx := context.Background()
	err = rdb.Set(ctx, "test", "hello", 0).Err()
	if err != nil {
		fmt.Printf("❌ Redis设置失败: %v\n", err)
		return
	}
	
	val, err := rdb.Get(ctx, "test").Result()
	if err != nil {
		fmt.Printf("❌ Redis获取失败: %v\n", err)
		return
	}
	
	fmt.Printf("✅ Redis测试成功，值: %s\n", val)
}
```

运行测试：
```bash
cd backend
go run test_redis.go
```

---

## 🚀 五、启动后端服务

### 5.1 安装依赖

```bash
cd backend
go mod download
```

### 5.2 启动服务

```bash
go run main.go
```

如果配置正确，应该看到：
```
Server starting on :8080
```

---

## 🔍 六、常见问题排查

### 问题1: 数据库连接失败

**错误**: `failed to connect to database`

**解决方案**:
1. 检查 PostgreSQL 是否运行：`psql -U postgres -c "SELECT version();"`
2. 检查用户名和密码是否正确
3. 检查数据库是否存在：`psql -U postgres -l`
4. 检查端口是否正确（默认5432）

---

### 问题2: 权限不足

**错误**: `permission denied`

**解决方案**:
1. 使用 `postgres` 超级用户，或
2. 授予用户足够权限：
```sql
GRANT ALL PRIVILEGES ON DATABASE naibao TO naibao_user;
GRANT ALL ON SCHEMA public TO naibao_user;
```

---

### 问题3: Redis 连接失败

**错误**: `failed to connect to Redis`

**解决方案**:
1. 检查 Redis 是否运行：`redis-cli ping`
2. 检查端口是否正确（默认6379）
3. 如果有密码，检查密码配置

---

### 问题4: 表不存在

**错误**: `relation "users" does not exist`

**解决方案**:
1. 确认已执行 `schema.sql`：`psql -U postgres -d naibao -f database/schema.sql`
2. 检查表是否存在：`psql -U postgres -d naibao -c "\dt"`

---

## 📝 七、快速配置脚本

### macOS/Linux 快速配置脚本

创建 `scripts/setup_db.sh`：

```bash
#!/bin/bash

# 数据库配置
DB_NAME="naibao"
DB_USER="postgres"

echo "📦 创建数据库..."
psql -U $DB_USER -c "CREATE DATABASE $DB_NAME;" 2>/dev/null || echo "数据库已存在"

echo "📋 导入表结构..."
psql -U $DB_USER -d $DB_NAME -f database/schema.sql

echo "📊 导入初始化数据..."
psql -U $DB_USER -d $DB_NAME -f database/init_data.sql

echo "✅ 数据库配置完成!"
echo ""
echo "请配置 backend/.env 文件："
echo "DB_HOST=localhost"
echo "DB_PORT=5432"
echo "DB_USER=$DB_USER"
echo "DB_PASSWORD=your_password"
echo "DB_NAME=$DB_NAME"
echo "DB_SSLMODE=disable"
```

使用方法：
```bash
chmod +x scripts/setup_db.sh
./scripts/setup_db.sh
```

---

## ✅ 八、配置检查清单

完成以下检查后，数据库配置就完成了：

- [ ] PostgreSQL 已安装并运行
- [ ] 数据库 `naibao` 已创建
- [ ] 表结构已导入（执行 schema.sql）
- [ ] 初始化数据已导入（执行 init_data.sql）
- [ ] Redis 已安装并运行
- [ ] 后端 `.env` 文件已配置（或环境变量已设置）
- [ ] 数据库连接测试通过
- [ ] Redis 连接测试通过
- [ ] 后端服务可以正常启动

---

**配置完成后，可以启动后端服务开始使用了！**
