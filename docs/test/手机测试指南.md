# 手机测试指南（多平台）

> 本指南以“低维护成本”为目标：不再要求改源码写死服务器地址。
>
> - H5 开发：默认通过 Vite dev server 反代 `/api` 到后端（同源，手机端最省心）
> - App/小程序/生产：通过 `VITE_API_BASE_URL` 显式配置后端地址

## 0. 本地验收（推荐：手机端最省心）

1) 启动本地后端（Docker）

```bash
docker compose -f "docker-compose.yml" up -d --build
curl -v "http://localhost:8080/health" --max-time 10
```

2) 启动前端（H5）

```bash
cd "frontend"
npm ci
npm run dev:h5
```

然后手机浏览器访问终端输出的 `Network` 地址（例如 `http://192.168.x.x:5173/`）。

说明：H5 开发默认让前端请求 `http://<手机访问的5173域名>/api/...`，由 Vite 反代到 `http://127.0.0.1:8080`（见 `frontend/vite.config.js`），手机无需直连 8080，也不会遇到 CORS。

---

## 0.1 外网手机验收（不在同一 Wi-Fi，可选）

如果你需要在外网用手机访问“本机 H5”，可以用临时隧道把 `5173` 暴露出去（无需改代码）。

最省心的一键方式（推荐）：

```bash
./scripts/start_mobile_preview.sh
```

脚本会输出一个 `https://*.trycloudflare.com` 地址，手机直接打开即可。
验收结束可停止：

```bash
./scripts/stop_mobile_preview.sh
```

方式 A：Cloudflare Tunnel（推荐，稳定性相对更好）

```bash
# 终端 1：启动前端
cd "frontend"
npm run dev:h5

# 终端 2：启动隧道（需要提前安装 cloudflared）
cloudflared tunnel --url "http://127.0.0.1:5173"
```

cloudflared 会输出一个 `https://*.trycloudflare.com` 地址，手机直接打开即可。

安装（macOS）：

```bash
brew install cloudflared
```

说明：这是临时地址；关闭 cloudflared 进程即失效。

---

## 1) 连接远程后端（可选）

如果你希望手机端直接使用远程后端（例如测试云服务器），有两种方式：

### 方式 A：H5 开发仍走反代（推荐）

在 `frontend/.env.local` 设置：

```env
VITE_API_PROXY_TARGET="http://<API_HOST>:8080"
```

然后照常 `npm run dev:h5`，手机访问 5173。

### 方式 B：多端/生产直接连后端

在 `frontend/.env.local` 设置：

```env
VITE_API_BASE_URL="http://<API_HOST>:8080"
```

前端实际请求会自动拼接 `/api`（见 `frontend/src/utils/api.js`）。

---

## 2) H5（手机浏览器）

```bash
cd "frontend"
npm ci
npm run dev:h5
```

然后手机浏览器访问终端输出的 `Network` 地址（例如 `http://192.168.x.x:5173/`）。

提示：如不设置 `VITE_API_BASE_URL`，默认同源 `/api` 由 Vite 反代（最稳）。

---

## 3) App（uni-app 真机调试）

```bash
cd "frontend"
npm run dev:app
```

如果你使用 HBuilderX，则按 HBuilderX 的“运行到手机/模拟器”流程即可。关键点仍是 `frontend/.env.local` 的 `VITE_API_BASE_URL` 必须指向可从手机访问的后端地址。

---

## 4) 微信小程序

```bash
cd "frontend"
npm run dev:mp-weixin
```

注意事项：

- 生产环境通常要求 HTTPS 且需要在微信公众平台配置“服务器域名”（request 合法域名）。
- 开发阶段可在微信开发者工具里勾选“不校验合法域名”（仅用于开发调试）。

---

## 网络与权限检查清单

- 安全组/防火墙放行后端端口（如 8080）。
- 后端健康检查 `GET /health` 可访问。
- 若出现 CORS 问题：优先用同源反代（Nginx）而不是扩大后端 CORS 白名单。
