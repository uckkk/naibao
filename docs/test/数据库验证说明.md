# 数据库验证说明

## ⚠️ 重要提示

为避免泄露与误提交，仓库内不再存放服务器明文密码/IP 等信息。

请先在本机配置 `scripts/.env.local`（参考 `scripts/.env.example`），至少包含：

- `SSH_HOST`
- `SSH_USER`
- `SSH_PORT`（可选，默认 22）

## ✅ 方法1：脚本验证（推荐）

### 步骤1：配置 SSH（推荐密钥认证）

```bash
cp scripts/.env.example scripts/.env.local
$EDITOR scripts/.env.local

# 初始化/配置 SSH 密钥（如服务器允许会自动写入；否则按提示手动操作）
./scripts/init_ssh.sh
```

### 步骤2：运行验证脚本

```bash
./scripts/verify_database.sh
```

---

## 🧪 方法2：手动验证

### 步骤1：SSH连接到服务器

```bash
ssh -p <SSH_PORT> <SSH_USER>@<SSH_HOST>
```

### 步骤2：在服务器上执行验证命令

```bash
# 1. 检查PostgreSQL服务
systemctl status postgresql

# 2. 检查数据库是否存在
sudo -u postgres psql -l | grep naibao

# 3. 检查表数量
sudo -u postgres psql -d naibao -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';"

# 4. 检查关键表
sudo -u postgres psql -d naibao -c "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' ORDER BY table_name;"

# 5. 检查奶粉品牌数据
sudo -u postgres psql -d naibao -c "SELECT COUNT(*) FROM formula_brands;"

# 6. 检查卫健委标准数据
sudo -u postgres psql -d naibao -c "SELECT COUNT(*) FROM health_standards;"

# 7. 检查feeding_settings表
sudo -u postgres psql -d naibao -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'feeding_settings';"
```

---

## 📋 验证清单

数据库验证成功应该满足：

- [ ] PostgreSQL服务运行中
- [ ] 数据库 `naibao` 存在
- [ ] 表数量 >= 15个
- [ ] 关键表存在：
  - [ ] `users` - 用户表
  - [ ] `babies` - 宝宝表
  - [ ] `feedings` - 喂养记录表
  - [ ] `formula_brands` - 奶粉品牌表
  - [ ] `health_standards` - 卫健委标准表
  - [ ] `feeding_settings` - 喂奶设置表（新添加）
- [ ] 初始化数据已导入：
  - [ ] 奶粉品牌数据 >= 12条
  - [ ] 卫健委标准数据 >= 10条

---

## 🔧 如果数据库未创建

### 创建数据库

```bash
# SSH连接到服务器
ssh -p <SSH_PORT> <SSH_USER>@<SSH_HOST>

# 创建数据库
sudo -u postgres psql -c "CREATE DATABASE naibao;"
```

### 导入表结构

```bash
# 在本地执行
scp -P <SSH_PORT> database/schema.sql <SSH_USER>@<SSH_HOST>:/tmp/

# 在服务器上执行
ssh -p <SSH_PORT> <SSH_USER>@<SSH_HOST>
sudo -u postgres psql -d naibao -f /tmp/schema.sql
```

### 导入初始化数据

```bash
# 在本地执行
scp -P <SSH_PORT> database/init_data.sql <SSH_USER>@<SSH_HOST>:/tmp/

# 在服务器上执行
ssh -p <SSH_PORT> <SSH_USER>@<SSH_HOST>
sudo -u postgres psql -d naibao -f /tmp/init_data.sql
```

---

## 🚀 快速验证命令（一键执行）

如果已配置SSH密钥，可以直接运行：

```bash
./scripts/verify_database.sh
```

脚本会自动检查所有项目并给出详细报告。

---

**请先配置SSH密钥，然后运行验证脚本！** 🔑
