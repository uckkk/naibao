# 服务器连接问题解决方案

## 问题诊断

**错误**: `ERR_CONNECTION_TIMED_OUT`
**原因**: 无法连接到服务器 `<API_HOST>:8080`

**测试结果**:
- ✅ 服务器IP可以ping通（网络可达）
- ❌ 8080端口连接超时（端口不可访问）

## 解决方案

### 方案1: 检查并启动后端服务（推荐）

```bash
# SSH连接到服务器
ssh -p <SSH_PORT> <SSH_USER>@<SSH_HOST>

# 检查服务状态
ps aux | grep naibao-server

# 如果服务未运行，启动服务
cd /opt/naibao/backend
./start_server.sh

# 查看日志
tail -f server.log
```

### 方案2: 检查防火墙和安全组

#### 2.1 检查服务器防火墙
```bash
# SSH连接到服务器
ssh -p <SSH_PORT> <SSH_USER>@<SSH_HOST>

# 检查防火墙状态
systemctl status firewalld
# 或
ufw status

# 如果防火墙开启，添加8080端口规则
# CentOS/RHEL:
firewall-cmd --permanent --add-port=8080/tcp
firewall-cmd --reload

# Ubuntu/Debian:
ufw allow 8080/tcp
```

#### 2.2 检查腾讯云安全组
1. 登录腾讯云控制台
2. 进入 **云服务器** → **安全组**
3. 找到服务器对应的安全组
4. 点击 **入站规则** → **添加规则**
5. 添加规则：
   - 类型：自定义
   - 来源：0.0.0.0/0
   - 协议端口：TCP:8080
   - 策略：允许
6. 保存规则

### 方案3: 检查服务器监听地址

确保服务器监听 `0.0.0.0:8080` 而不是 `127.0.0.1:8080`

```bash
# SSH连接到服务器
ssh -p <SSH_PORT> <SSH_USER>@<SSH_HOST>

# 检查端口监听
netstat -tlnp | grep 8080

# 应该显示类似：
# tcp6  0  0 :::8080  :::*  LISTEN  26745/./naibao-server
# 或
# tcp  0  0 0.0.0.0:8080  0.0.0.0:*  LISTEN  26745/./naibao-server

# 如果只显示 127.0.0.1:8080，需要修改配置
```

### 方案4: 临时使用本地后端（开发测试）

如果需要立即测试，可以临时在本地运行后端：

```bash
# 在本地启动后端
cd backend
go run main.go
```

然后修改前端配置：
```bash
cp frontend/.env.example frontend/.env.local
# 将 VITE_API_BASE_URL 设置为本地后端
# VITE_API_BASE_URL=http://localhost:8080
```

## 验证步骤

### 1. 验证服务器端口
```bash
# 从本地测试
curl -v http://<API_HOST>:8080/health --max-time 5
```

### 2. 验证安全组
- 确保安全组规则已添加
- 确保规则已生效

### 3. 验证服务运行
```bash
# SSH到服务器
ssh -p <SSH_PORT> <SSH_USER>@<SSH_HOST>
ps aux | grep naibao-server
netstat -tlnp | grep 8080
```

## 常见问题

### Q: 为什么ping通但端口不通？
A: ping使用的是ICMP协议，端口访问使用的是TCP协议。防火墙可能允许ICMP但阻止TCP。

### Q: 安全组已添加规则但还是不通？
A: 
1. 检查规则是否已保存
2. 检查服务器防火墙是否也阻止了
3. 等待几分钟让规则生效

### Q: 如何确认服务器在监听？
A: 运行 `netstat -tlnp | grep 8080`，应该看到监听地址是 `0.0.0.0:8080` 或 `:::8080`

## 下一步

1. **优先检查服务器状态**：确保后端服务正在运行
2. **检查安全组**：确保腾讯云安全组开放了8080端口
3. **检查防火墙**：确保服务器防火墙允许8080端口
4. **验证连接**：使用 `curl` 或浏览器测试连接

完成以上步骤后，再次尝试注册功能。

