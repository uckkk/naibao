# 本机托管运营台（Home Ops Console）

目标：让你在本机托管后端时，**通过一个脚本打开网页**就能看到运行状态并完成重启/修复。

## 一键启动

方式 A（推荐）：macOS 双击启动（更像“应用”）

- 方式 A0：双击 `.app`（无终端，更像 App）
  - 第一次先双击：`奶宝生成运营台App.command`（会在仓库根目录生成一组 App）
  - 然后双击：
    - `奶宝运营台.app`（启动/打开运营台）
    - `停止奶宝运营台.app`（关闭运营台）
    - `奶宝手机验收.app`（启动手机外网验收，自动打开并复制链接）
    - `停止奶宝手机验收.app`

> 注意：生成后的 `.app` 需要放在仓库根目录（与 `scripts/` 同级），不要移动位置，否则找不到脚本。
>
> 若双击没有任何反应：
> - 先尝试右键 -> 打开（绕过 Gatekeeper 的首次拦截）
> - 再查看日志：`.naibao_runtime/ops_console.app.log`
>
> 若运营台提示「未检测到 Docker 命令」，但你确认已安装 Docker Desktop / OrbStack：
> - 先关闭运营台（右上角「设置」->「关闭运营台」或双击 `停止奶宝运营台.app`）
> - 再重新打开 `奶宝运营台.app`
> - 并确认 Docker Desktop / OrbStack 已启动完成（否则 Docker 引擎仍会显示不可用）

- 双击运行仓库根目录的任意一个：
  - `奶宝运营台.command`（推荐）
  - `naibao_ops.command`（同功能的英文文件名）

> 第一次可能会被 macOS 拦截（因为它是从网络下载的脚本）。
> 解决：右键 -> 打开；或在“系统设置 -> 隐私与安全性”里允许打开。

额外：手机外网验收（临时域名）

- 启动：`奶宝手机验收启动.command`（会生成一个 `trycloudflare.com` 外网链接，并自动复制到剪贴板）
- 停止：`奶宝手机验收停止.command`

额外：固定外网域名（推荐，用于长期线上）

- 推荐做法：在运营台的「③ 固定域名上线」分组里，找到「4. 固定外网初始化（一次性）」卡片，直接点「一键初始化」
- 兜底（不用运营台也能做）：双击 `奶宝固定外网域名初始化.command`（会打开浏览器进行 Cloudflare 授权，并生成本项目的 tunnel 配置）

方式 B：命令行启动

在仓库根目录执行：

```bash
chmod +x scripts/local_ops.sh
./scripts/local_ops.sh
```

默认会打开浏览器：

- `http://127.0.0.1:17623`

> 若端口已被占用，运营台会自动复用已在运行的运营台；或自动切换到一个空闲端口并打开。

> 出于安全考虑，默认只允许本机访问。若你确实要手机同 Wi-Fi 查看，可把运营台的 bind 改成 `0.0.0.0`（建议配合路由器/防火墙限制）。

## 它能做什么

  - 用“小卡片”一眼看懂关键指标（颜色区分：正常/关注/异常）：
  - 按 ①②③④ 分组显示（更像“产品”的步骤流）：
    - ① 本机启动/修复：只需点按钮（先做）
    - ② 手机外网验收：临时外网链接（可选）
    - ③ 固定域名上线：1 接入 NS；2 配 Cloudflare DNS；3 配 GitHub Pages；4 初始化通道；5-7 启动外网通道并验证（一次性）
    - ④ 资源与版本：仅信息/排障
  - 每个分组右侧会显示“需处理：X红 / Y橙”
  - 默认仅显示需要处理项；右上角「设置」可切换“只看需处理/自动刷新/手动刷新”
  - 点任意一行：若该行有「待办清单」会直接打开（推荐路径）；否则弹出 iOS 风格操作面板（Action Sheet）
  - 每张卡片都尽量提供「待办清单」：把长段说明拆成可操作步骤（带跳转链接 + 需要填写的内容 + 一键复制）
  - 「Cloudflare DNS（一次配完）」：把需要在 Cloudflare DNS 里设置的 A / www /（可选）TXT / api 值集中展示，一次设置完，避免分散在多个入口
  - 「GitHub Pages（一次配完）」：把需要在 GitHub 里设置的内容集中展示（Pages Source / Custom domain / Enforce HTTPS /（可选）Verified domains），并提供仓库级直达链接与部署日志入口
  - 点按钮失败时会给出“短提示”，必要时自动弹出“详情”（方便复制给开发/AI 排查）
  - 「手机外网验收」支持一键启动/重启/停止，并可直接复制外网链接
  - Docker 引擎是否可用
  - 后端端口（默认 `18080`，可自动避让端口冲突；也可在 `deploy/.env.home` 里用 `NB_BACKEND_HOST_PORT` 覆盖）
  - docker 三个服务：`db / redis / backend` 的运行/健康状态（每个服务支持一键重启 + 日志）
  - 后端健康：
    - 本机：`http://127.0.0.1:18080/health`（以运营台显示为准）
    - 公网：`https://api.naibao.me/api/health`
  - DNS 解析状态（例如 `api.naibao.me` 是否已配置）
  - 主机资源：磁盘/内存/负载/运行时长（低磁盘时提供“一键清理 Docker 缓存”）
- 全局一键操作（适合非技术同学）：
  - 一键启动/修复（首屏「一键启动/修复」）
  - 右上角「设置」仅保留显示偏好与危险操作（例如：停止全部服务 / 关闭运营台），并会二次确认

## GitHub Pages 绑定域名时的 TXT 验证（常见）

当你在 GitHub Pages 里填写 `naibao.me` 作为自定义域名时，GitHub 可能会要求你先添加一条 DNS TXT 记录来验证域名所有权（防止他人抢绑你的域名）。

处理方法：

- 按 GitHub 页面提示，在 Cloudflare 的 DNS 里新增 1 条 TXT：
  - 记录名：通常是 `_github-pages-challenge-<你的GitHub用户名>`（GitHub 页面会给出完整值）
  - 值：一串校验码（从 GitHub 页面复制）
  - TTL：自动
- 等待 DNS 生效后，回 GitHub 点击「校验/Verify」

> 提示：
> - 这条 TXT 记录不是你的电脑 IP，也不影响 A/CNAME 配置；验证通过后可保留或删除。
> - Verified domains 是 GitHub 账号级（全局）配置：在运营台的「3. GitHub Pages（一次配完）」卡片里有直达入口与说明。

## 配置文件在哪里

首次运行会自动生成（本机文件，不提交仓库）：

- `deploy/.env.home`

你可以按需修改：

- `CORS_ALLOW_ORIGINS=https://naibao.me,https://www.naibao.me`
- `NB_TUNNEL_MODE=named`
- `NB_TUNNEL_NAME=naibao-api`
- `NB_TUNNEL_HOSTNAME=api.naibao.me`

## Cloudflare 外网通道说明

若你要让 GitHub Pages 的前端长期稳定访问后端，**必须使用固定外网通道（Named Tunnel）**（固定域名 `api.naibao.me`）。

运营台会尝试启动固定外网通道；如果你还未完成 Cloudflare 的首次授权/创建通道，日志里会提示原因。

常见疑问：为什么 `dig +short CNAME api.naibao.me` 返回空？

- 正常现象：`api` 记录在 Cloudflare 通常是「已代理（橙云）」；此时 Cloudflare 会对外返回自己的 A/AAAA（边缘 IP），而不是把真实 CNAME 直接暴露出来。
- 正确验证方式：
  - DNS 层：`dig +short A api.naibao.me`（应返回 Cloudflare 的 IP）
  - 业务层：打开 `https://api.naibao.me/api/health` 或在运营台看「6. API 外网」是否变绿（200）
