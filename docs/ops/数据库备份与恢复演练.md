# 数据库备份与恢复演练（PostgreSQL）

目标：
- **每天自动备份**（至少保留 7 天）
- 能做一次“恢复演练”（恢复到新库验证），确保备份不是摆设

> 适用范围：本仓库 `deploy/docker-compose.prod.yml` 的生产形态（db 在 Docker 里）。

## 1) 备份（pg_dump）

备份脚本：`scripts/pg_backup.sh`

首次使用：

```bash
chmod +x scripts/pg_backup.sh
```

手动跑一次：

```bash
./scripts/pg_backup.sh
```

备份输出目录（默认）：
- `backups/postgres/naibao_YYYYMMDD_HHMMSS.sql.gz`

可选：按“保留 7 天”清理旧备份（只会清理上述目录里的 `.sql.gz`）：

```bash
./scripts/pg_backup.sh --prune
```

## 2) 定时任务（Cron）

示例：每天凌晨 03:10 备份一次（并做 7 天清理）

```bash
crontab -e
```

加入：

```cron
10 3 * * * cd /opt/naibao && ./scripts/pg_backup.sh --prune >> /var/log/naibao_pg_backup.log 2>&1
```

## 3) 恢复演练（安全默认：恢复到新库）

恢复脚本：`scripts/pg_restore.sh`

首次使用：

```bash
chmod +x scripts/pg_restore.sh
```

恢复到新库（默认 `naibao_restore`）：

```bash
./scripts/pg_restore.sh backups/postgres/naibao_20260208_031000.sql.gz
```

或指定新库名：

```bash
./scripts/pg_restore.sh backups/postgres/naibao_20260208_031000.sql.gz naibao_restore_20260208
```

恢复完成后，建议你：
1) 临时把后端环境变量 `DB_NAME` 指向恢复库
2) 启动后端并做基本验收（登录/首页/记录/报告）
3) 确认无误后，再决定是否需要“覆盖恢复”（覆盖恢复风险更高，建议手工执行并先停机）

## 4) 最低限度验收清单

- 备份文件能生成且大小合理（非 0）
- 恢复脚本能在 10 分钟内完成（数据量小的情况下更快）
- 恢复后能正常登录、打开首页、查看记录、生成报告

