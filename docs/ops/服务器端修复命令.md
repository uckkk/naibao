# 服务器端修复命令

## 问题1：修复CORS配置

请在服务器上执行以下命令：

```bash
cd /opt/naibao/backend

# 停止服务
./stop_server.sh

# 检查当前CORS配置
grep -n "Access-Control-Allow-Credentials" router/middleware/cors.go

# 修复CORS配置（将第17行的true改为false）
sed -i 's/Access-Control-Allow-Credentials", "true"/Access-Control-Allow-Credentials", "false"/' router/middleware/cors.go

# 或者直接编辑文件
nano router/middleware/cors.go
# 找到第17行，将 true 改为 false

# 验证修改
grep -n "Access-Control-Allow-Credentials" router/middleware/cors.go

# 重新编译
go build -o naibao-server main.go

# 启动服务
./start_server.sh

# 测试
curl -v http://127.0.0.1:8080/health | grep -i "access-control"
```

## 问题2：腾讯云安全组配置（最重要）

**这是导致外部无法访问的主要原因！**

### 步骤：

1. **登录腾讯云控制台**
   - 访问：https://console.cloud.tencent.com/

2. **进入安全组管理**
   - 云服务器 → 安全组
   - 或者直接搜索"安全组"

3. **找到服务器对应的安全组**
   - 查看服务器详情，找到绑定的安全组

4. **添加入站规则**
   - 点击安全组 → 入站规则 → 添加规则
   - 配置如下：
     ```
     类型：自定义
     来源：0.0.0.0/0
     协议端口：TCP:8080
     策略：允许
     备注：后端API服务
     ```

5. **保存规则**

6. **验证**
   - 等待1-2分钟让规则生效
   - 从外部测试：`curl http://<API_HOST>:8080/health`

## 问题3：验证修复

修复后，请执行以下测试：

```bash
# 1. 检查CORS配置
curl -v http://127.0.0.1:8080/health 2>&1 | grep -i "access-control"

# 应该看到：
# Access-Control-Allow-Credentials: false
# Access-Control-Allow-Origin: *

# 2. 测试注册接口
curl -X POST http://127.0.0.1:8080/api/public/register \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","password":"123456"}'

# 3. 从外部测试（需要先配置安全组）
curl http://<API_HOST>:8080/health
```

## 当前状态

✅ **已完成**：
- 服务正在运行
- 防火墙已开放8080端口
- 本地连接正常

❌ **待完成**：
- 修复CORS配置（将Credentials改为false）
- **配置腾讯云安全组（开放8080端口）** ← 最重要！

## 下一步

1. **立即配置腾讯云安全组**（这是最关键的）
2. 修复CORS配置
3. 重新测试注册功能

