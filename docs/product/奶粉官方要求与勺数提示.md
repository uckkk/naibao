# 奶粉官方要求与勺数提示功能设计

## 🎯 功能需求

用户选中奶粉后，系统自动：
1. 获取奶粉官方要求（冲泡比例、水温、勺数规格等）
2. 根据官方建议计算勺数
3. 在喂养界面显示勺数提示

---

## 📊 一、数据结构设计

### 1.1 奶粉品牌信息表

```sql
-- 奶粉品牌表
CREATE TABLE formula_brands (
  id SERIAL PRIMARY KEY,
  name_cn VARCHAR(100) NOT NULL,           -- 中文名
  name_en VARCHAR(100),                    -- 英文名
  logo_url VARCHAR(255),                   -- Logo地址
  market_share DECIMAL(5,2),               -- 市场份额
  features TEXT[],                          -- 特性标签数组
  official_url VARCHAR(255),               -- 官方网站
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### 1.2 奶粉官方要求表

```sql
-- 奶粉官方要求表
CREATE TABLE formula_specifications (
  id SERIAL PRIMARY KEY,
  brand_id INTEGER NOT NULL REFERENCES formula_brands(id),
  series_name VARCHAR(100),                -- 系列名称（如：至初、启赋）
  age_range VARCHAR(20),                    -- 适用月龄（如：0-6月、6-12月）
  
  -- 勺数规格
  scoop_weight_gram DECIMAL(5,2) NOT NULL,  -- 一勺重量（克），如：4.5g
  scoop_ml DECIMAL(5,2) NOT NULL,           -- 一勺对应水量（ml），如：30ml
  
  -- 冲泡要求
  water_temp_min INTEGER,                   -- 建议水温最低（℃）
  water_temp_max INTEGER,                   -- 建议水温最高（℃）
  mixing_method TEXT,                       -- 冲泡方法说明
  
  -- 喂养建议
  feeding_frequency TEXT,                   -- 喂养频率建议
  daily_amount_min INTEGER,                 -- 每日建议最低量（ml）
  daily_amount_max INTEGER,                 -- 每日建议最高量（ml）
  
  -- 数据来源
  data_source VARCHAR(255),                 -- 数据来源（官网/包装/官方客服）
  verified_at TIMESTAMP,                    -- 验证时间
  is_verified BOOLEAN DEFAULT FALSE,        -- 是否已人工验证
  
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(brand_id, series_name, age_range)
);
```

### 1.3 用户选择的奶粉

```sql
-- 用户奶粉选择表
CREATE TABLE user_formula_selections (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL,
  baby_id INTEGER NOT NULL,
  brand_id INTEGER NOT NULL REFERENCES formula_brands(id),
  series_name VARCHAR(100),                 -- 系列名称
  age_range VARCHAR(20),                    -- 当前适用月龄段
  selected_at TIMESTAMP DEFAULT NOW(),
  is_active BOOLEAN DEFAULT TRUE            -- 是否当前使用
);
```

---

## 🧮 二、勺数计算算法

### 2.1 根据奶量计算勺数

```typescript
interface FormulaSpec {
  scoopWeightGram: number;    // 一勺重量（g）
  scoopMl: number;            // 一勺对应水量（ml）
}

interface FeedingCalculation {
  milkAmount: number;         // 总奶量（ml）
  scoops: number;              // 需要的勺数
  waterAmount: number;         // 需要的水量（ml）
  powderWeight: number;        // 奶粉重量（g）
}

/**
 * 计算需要的勺数和水量
 */
function calculateFeedingAmount(
  milkAmount: number,          // 目标奶量（ml）
  spec: FormulaSpec            // 奶粉规格
): FeedingCalculation {
  // 计算需要的勺数（向上取整）
  const scoops = Math.ceil(milkAmount / spec.scoopMl);
  
  // 计算实际水量（根据实际勺数）
  const actualWater = scoops * spec.scoopMl;
  
  // 计算奶粉重量
  const powderWeight = scoops * spec.scoopWeightGram;
  
  return {
    milkAmount: actualWater,      // 实际奶量（可能略多于目标）
    scoops,
    waterAmount: actualWater,
    powderWeight
  };
}

// 使用示例
const spec: FormulaSpec = {
  scoopWeightGram: 4.5,   // A2至初：一勺4.5g
  scoopMl: 30              // 一勺对应30ml水
};

const result = calculateFeedingAmount(150, spec);
// 结果：{ milkAmount: 150, scoops: 5, waterAmount: 150, powderWeight: 22.5 }
```

---

### 2.2 根据勺数计算奶量

```typescript
/**
 * 根据勺数计算奶量
 */
function calculateMilkFromScoops(
  scoops: number,
  spec: FormulaSpec
): number {
  return scoops * spec.scoopMl;
}

// 使用示例：3勺对应多少ml
const milkAmount = calculateMilkFromScoops(3, spec);
// 结果：90ml
```

---

## 🎨 三、UI交互设计

### 3.1 选择奶粉页面增强

#### **品牌卡片增加系列选择：**
```
┌─────────────────────────────┐
│  [品牌Logo]                   │
│  金领冠 (JINLINGGUAN)        │
│                              │
│  请选择系列：                 │
│  ○ 基础系列                  │
│  ○ α+β蛋白系列               │
│  ○ 珍护系列                  │
│                              │
│  适用月龄：                   │
│  ○ 0-6个月                   │
│  ● 6-12个月 [已选]           │
│                              │
│  官方规格：                   │
│  一勺 = 4.5g + 30ml水        │
│  水温：40-50℃                │
│                              │
│  [确认选择]                   │
└─────────────────────────────┘
```

---

### 3.2 一键投喂弹窗增强

#### **显示勺数提示：**
```
┌─────────────────────────────┐
│  推荐奶量                     │
│  150 ml      [大号加粗显示]    │
│                              │
│  参考范围：700-900 ml/天      │
│  [小字灰色，显示月龄标准]      │
│                              │
│  ─────────────────────────   │
│  冲泡建议（A2至初）：          │
│  🥄 5勺（4.5g/勺）            │
│  💧 150ml温水（40-50℃）      │
│  [点击查看详细冲泡步骤]        │
│                              │
│  今日已摄入：440 ml / 810 ml │
│  [进度条显示]                │
│                              │
│  剩余喂养次数：4次           │
│                              │
│  [如有预警，显示提示]         │
│                              │
│  快速调整：                  │
│  [-50] [-20] [-10] [+10] [+20] [+50]
│                              │
│  或手动输入：[______] ml     │
│                              │
│  [取消]  [确认投喂]          │
└─────────────────────────────┘
```

---

### 3.3 冲泡步骤详情页

```
┌─────────────────────────────┐
│  ← 冲泡步骤                   │
├─────────────────────────────┤
│                              │
│  品牌：A2至初                 │
│  系列：至初系列               │
│  适用：6-12个月               │
│                              │
│  📋 规格说明                  │
│  一勺奶粉：4.5g               │
│  一勺对应水量：30ml           │
│  建议水温：40-50℃            │
│                              │
│  📝 冲泡步骤                  │
│  1. 洗净双手和奶瓶            │
│  2. 将150ml温水（40-50℃）    │
│     倒入奶瓶                  │
│  3. 加入5勺奶粉（平勺）       │
│  4. 盖紧瓶盖，摇匀至溶解      │
│  5. 测试温度后即可喂养        │
│                              │
│  ⚠️ 注意事项                  │
│  • 使用配套量勺               │
│  • 每勺需刮平                 │
│  • 不要用力压实奶粉           │
│  • 水温不宜过高，以免破坏      │
│    营养成分                   │
│                              │
│  [关闭]                      │
└─────────────────────────────┘
```

---

## 🔄 四、数据获取策略

### 4.1 数据来源优先级

#### **优先级1：官方数据（最准确）**
- 官网产品页面
- 官方App
- 包装盒说明
- 官方客服确认

#### **优先级2：用户验证（补充）**
- 用户反馈纠正
- 社区验证
- 专业机构数据

#### **优先级3：行业标准（默认）**
- 通用标准（如：一勺≈4.5g，≈30ml水）
- 仅在没有官方数据时使用

---

### 4.2 数据维护机制

#### **后台管理：**
```
管理员后台 → 奶粉品牌管理
    ↓
添加/编辑品牌
    ↓
填写官方要求数据：
├─ 系列名称
├─ 适用月龄
├─ 勺数规格（一勺重量、对应水量）
├─ 冲泡要求（水温、方法）
└─ 数据来源（官网链接/包装照片）
    ↓
人工验证标记
    ↓
发布到前端使用
```

#### **数据更新流程：**
1. 发现新品牌/新系列 → 管理员添加
2. 用户反馈数据错误 → 管理员核实更新
3. 品牌方更新规格 → 定期检查更新
4. 每年全面审查一次

---

## 💻 五、技术实现

### 5.1 前端实现（uni-app）

#### **获取用户选择的奶粉规格：**
```vue
<script>
export default {
  data() {
    return {
      selectedFormula: null,      // 用户选择的奶粉
      formulaSpec: null,          // 奶粉规格
      recommendedMilk: 150,       // 推荐奶量
      calculatedScoops: 0         // 计算的勺数
    }
  },
  
  async onLoad() {
    // 获取用户选择的奶粉
    await this.loadSelectedFormula();
    // 计算勺数
    this.calculateScoops();
  },
  
  methods: {
    // 加载用户选择的奶粉
    async loadSelectedFormula() {
      const res = await api.get('/user/formula/current', {
        babyId: this.babyId
      });
      
      if (res.data) {
        this.selectedFormula = res.data;
        // 获取奶粉规格
        await this.loadFormulaSpec();
      }
    },
    
    // 加载奶粉规格
    async loadFormulaSpec() {
      const res = await api.get('/formula/spec', {
        brandId: this.selectedFormula.brandId,
        seriesName: this.selectedFormula.seriesName,
        ageRange: this.selectedFormula.ageRange
      });
      
      this.formulaSpec = res.data;
      this.calculateScoops();
    },
    
    // 计算勺数
    calculateScoops() {
      if (!this.formulaSpec || !this.recommendedMilk) return;
      
      const scoops = Math.ceil(
        this.recommendedMilk / this.formulaSpec.scoopMl
      );
      this.calculatedScoops = scoops;
    },
    
    // 奶量变化时重新计算
    onMilkAmountChange(amount) {
      this.recommendedMilk = amount;
      this.calculateScoops();
    }
  }
}
</script>

<template>
  <view class="feed-modal">
    <!-- 推荐奶量 -->
    <view class="recommended-amount">
      <text class="amount">{{ recommendedMilk }}ml</text>
    </view>
    
    <!-- 勺数提示（如果有选择的奶粉） -->
    <view v-if="formulaSpec" class="scoop-suggestion">
      <view class="suggestion-title">冲泡建议（{{ selectedFormula.brandName }}）：</view>
      <view class="suggestion-content">
        <text class="scoop-icon">🥄</text>
        <text class="scoop-text">{{ calculatedScoops }}勺（{{ formulaSpec.scoopWeightGram }}g/勺）</text>
      </view>
      <view class="suggestion-content">
        <text class="water-icon">💧</text>
        <text class="water-text">{{ recommendedMilk }}ml温水（{{ formulaSpec.waterTempMin }}-{{ formulaSpec.waterTempMax }}℃）</text>
      </view>
      <text class="detail-link" @click="showBrewingSteps">点击查看详细冲泡步骤</text>
    </view>
    
    <!-- 如果没有选择奶粉，显示提示 -->
    <view v-else class="no-formula-tip">
      <text>请先选择奶粉品牌，获取官方冲泡建议</text>
      <button @click="goToFormulaSelect">去选择奶粉</button>
    </view>
  </view>
</template>
```

---

### 5.2 后端API

#### **获取奶粉规格：**
```go
// GET /api/formula/spec
func GetFormulaSpec(c *gin.Context) {
    brandId := c.Query("brandId")
    seriesName := c.Query("seriesName")
    ageRange := c.Query("ageRange")
    
    spec, err := db.GetFormulaSpec(brandId, seriesName, ageRange)
    if err != nil {
        c.JSON(500, gin.H{"error": err.Error()})
        return
    }
    
    c.JSON(200, gin.H{
        "scoopWeightGram": spec.ScoopWeightGram,
        "scoopMl": spec.ScoopMl,
        "waterTempMin": spec.WaterTempMin,
        "waterTempMax": spec.WaterTempMax,
        "mixingMethod": spec.MixingMethod,
    })
}
```

---

## 📋 六、数据初始化

### 6.1 常见品牌数据（示例）

#### **A2至初系列：**
```json
{
  "brandId": 12,
  "seriesName": "至初系列",
  "ageRange": "0-6个月",
  "scoopWeightGram": 4.5,
  "scoopMl": 30,
  "waterTempMin": 40,
  "waterTempMax": 50,
  "dataSource": "官网包装说明"
}
```

#### **金领冠α+β蛋白系列：**
```json
{
  "brandId": 2,
  "seriesName": "α+β蛋白系列",
  "ageRange": "0-6个月",
  "scoopWeightGram": 4.3,
  "scoopMl": 30,
  "waterTempMin": 40,
  "waterTempMax": 50,
  "dataSource": "官网包装说明"
}
```

---

### 6.2 数据录入方式

#### **方式1：Excel批量导入（推荐）**
```
管理员后台 → 导入Excel
├─ 品牌名称
├─ 系列名称
├─ 适用月龄
├─ 勺数规格
└─ 冲泡要求
```

#### **方式2：手动录入**
管理员后台逐个添加

---

## ✅ 七、实施计划

### Phase 1：数据库和数据结构（Week 1）
- [ ] 创建奶粉规格表
- [ ] 初始化常见品牌数据
- [ ] API接口开发

### Phase 2：前端集成（Week 2）
- [ ] 选择奶粉页面增强（系列选择）
- [ ] 一键投喂弹窗显示勺数提示
- [ ] 冲泡步骤详情页

### Phase 3：后台管理（Week 3）
- [ ] 奶粉规格管理界面
- [ ] 数据录入功能
- [ ] Excel导入功能

---

## 🎯 用户体验提升

### 核心价值：
1. **准确性**：基于官方数据，避免错误冲泡
2. **便捷性**：自动计算，无需手动换算
3. **专业性**：官方要求，科学喂养
4. **个性化**：根据用户选择的品牌定制提示

---

**文档版本：** v1.0  
**创建时间：** 2025年1月

