# 数据分享方案 - 最快技术路径

## 🚀 一、最短技术路径分析

### 方案对比

| 方案 | 技术复杂度 | 分享速度 | 用户体验 | 推荐度 |
|------|-----------|---------|---------|--------|
| **方案A：邀请码** | ⭐ 低 | ⭐⭐⭐⭐⭐ 最快 | ⭐⭐⭐⭐ | ✅ **推荐** |
| 方案B：二维码 | ⭐⭐ 中 | ⭐⭐⭐⭐ 快 | ⭐⭐⭐⭐ | ✅ 可选 |
| 方案C：链接分享 | ⭐⭐ 中 | ⭐⭐⭐ 一般 | ⭐⭐⭐ | ⚠️ 一般 |
| 方案D：手机号查找 | ⭐⭐⭐ 高 | ⭐⭐⭐ 一般 | ⭐⭐⭐ | ❌ 不推荐 |

---

## ✅ 最终方案：邀请码 + 二维码（双路径）

### 方案A：邀请码（最快，主推）

#### **流程：**
```
用户A（主账号）
    ↓
点击"邀请家人"
    ↓
生成邀请码（6位数字，如：123456）
    ↓
显示分享弹窗：
┌─────────────────────────────┐
│  邀请家人                     │
│                              │
│  邀请码：                     │
│  🔢 1 2 3 4 5 6             │
│  [复制] [生成二维码]          │
│                              │
│  家人打开APP，输入邀请码即可  │
│  自动加入，无需审核          │
└─────────────────────────────┘
    ↓
用户B（家人）
    ↓
打开APP → 点击"加入家庭"
    ↓
输入邀请码：123456
    ↓
自动加入，立即同步数据
```

#### **技术实现：**
```javascript
// 1. 生成邀请码（6位数字，有效期7天）
function generateInviteCode(babyId) {
  const code = Math.floor(100000 + Math.random() * 900000).toString();
  // 存储到数据库，关联babyId和userId
  await db.inviteCodes.create({
    code,
    babyId,
    creatorId: userId,
    expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
    used: false
  });
  return code;
}

// 2. 使用邀请码（前端）
async function joinByCode(code) {
  const invite = await api.post('/invite/use', { code });
  if (invite.success) {
    // 自动添加到家庭成员列表
    // 自动同步数据
    showToast('已成功加入家庭');
  }
}
```

#### **优势：**
- ✅ **速度最快**：输入6位数字，立即加入
- ✅ **无需审核**：自动加入，即时生效
- ✅ **安全性好**：7天有效期，使用后失效
- ✅ **实现简单**：数据库一张表即可

---

### 方案B：二维码（辅助，提升体验）

#### **流程：**
```
用户A生成邀请码后，点击"生成二维码"
    ↓
显示二维码
    ↓
用户B用APP扫描二维码
    ↓
自动识别邀请码，跳转到加入页面
    ↓
确认加入 → 自动同步数据
```

#### **技术实现：**
```vue
<template>
  <view class="qr-code-container">
    <qrcode 
      :value="inviteUrl" 
      :size="200"
    />
    <text>扫码加入家庭</text>
  </view>
</template>

<script>
export default {
  data() {
    return {
      inviteUrl: `naibao://invite/${inviteCode}`
      // 或者：https://naibao.com/invite/123456
    }
  }
}
</script>
```

#### **优势：**
- ✅ 更便捷（扫码即可）
- ✅ 适合面对面分享
- ✅ 可以保存图片分享到微信

---

## 🔐 二、权限管理

### 2.1 角色定义

#### **角色类型：**
1. **管理员**（创建者）
   - 所有权限：编辑、删除、邀请、移除成员

2. **成员**（家人）
   - 查看权限：查看所有数据
   - 编辑权限：可添加喂养记录
   - 限制权限：不能删除其他人的记录，不能邀请新成员

3. **访客**（可选）
   - 仅查看：只能查看数据，不能编辑

---

### 2.2 数据同步机制

#### **实时同步（WebSocket）：**
```
用户A添加喂养记录
    ↓
服务器接收 → 保存到数据库
    ↓
通过WebSocket推送给所有在线成员
    ↓
用户B/用户C自动更新界面
（延迟 < 100ms）
```

#### **离线同步（本地优先）：**
```
用户离线时添加记录
    ↓
保存到本地SQLite
    ↓
上线后自动同步到服务器
    ↓
服务器分发到其他成员设备
```

---

## 🛠️ 三、技术实现细节

### 3.1 数据库设计

#### **邀请码表（invite_codes）：**
```sql
CREATE TABLE invite_codes (
  id SERIAL PRIMARY KEY,
  code VARCHAR(6) UNIQUE NOT NULL,  -- 6位数字
  baby_id INTEGER NOT NULL,
  creator_id INTEGER NOT NULL,      -- 创建者
  expires_at TIMESTAMP NOT NULL,     -- 过期时间
  used BOOLEAN DEFAULT FALSE,       -- 是否已使用
  used_by INTEGER,                   -- 使用者ID
  used_at TIMESTAMP,                 -- 使用时间
  created_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_code ON invite_codes(code);
CREATE INDEX idx_baby_id ON invite_codes(baby_id);
```

#### **家庭成员表（family_members）：**
```sql
CREATE TABLE family_members (
  id SERIAL PRIMARY KEY,
  baby_id INTEGER NOT NULL,
  user_id INTEGER NOT NULL,
  role VARCHAR(20) DEFAULT 'member',  -- admin/member/guest
  joined_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(baby_id, user_id)
);
```

---

### 3.2 API接口

#### **生成邀请码：**
```
POST /api/invite/generate
Request: { babyId: 123 }
Response: {
  code: "123456",
  qrCode: "data:image/png;base64,...",
  expiresAt: "2024-11-22T15:30:00Z"
}
```

#### **使用邀请码：**
```
POST /api/invite/use
Request: { code: "123456" }
Response: {
  success: true,
  babyId: 123,
  babyName: "元宝",
  message: "已成功加入家庭"
}
```

#### **家庭成员列表：**
```
GET /api/family/members?babyId=123
Response: {
  members: [
    { userId: 1, nickname: "爸爸", role: "admin", avatar: "..." },
    { userId: 2, nickname: "妈妈", role: "member", avatar: "..." }
  ]
}
```

---

### 3.3 前端实现

#### **生成邀请码页面：**
```vue
<template>
  <view class="invite-page">
    <view class="code-display">
      <text class="code-label">邀请码</text>
      <view class="code-numbers">
        <text 
          v-for="(digit, i) in code" 
          :key="i"
          class="digit"
        >{{ digit }}</text>
      </view>
      <button @click="copyCode">复制</button>
    </view>
    
    <view class="qr-code-section">
      <image :src="qrCodeUrl" class="qr-image" />
      <text>扫码加入</text>
    </view>
    
    <view class="hint">
      <text>• 邀请码7天内有效</text>
      <text>• 使用后自动失效</text>
      <text>• 最多可邀请10位家人</text>
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      code: '',
      qrCodeUrl: ''
    }
  },
  async onLoad() {
    await this.generateInvite();
  },
  methods: {
    async generateInvite() {
      const res = await api.post('/invite/generate', {
        babyId: this.babyId
      });
      this.code = res.code;
      this.qrCodeUrl = res.qrCode;
    },
    copyCode() {
      uni.setClipboardData({
        data: this.code,
        success: () => {
          uni.showToast({ title: '已复制到剪贴板' });
        }
      });
    }
  }
}
</script>
```

---

## 📊 四、实施优先级

### P0（必须实现）
- [x] 邀请码生成和使用
- [x] 家庭成员添加
- [x] 数据实时同步
- [x] 权限控制（管理员/成员）

### P1（建议实现）
- [ ] 二维码生成和扫描
- [ ] 邀请码有效期管理
- [ ] 成员列表展示
- [ ] 移除成员功能

### P2（可选）
- [ ] 邀请码使用记录
- [ ] 批量邀请
- [ ] 邀请链接（分享到微信）

---

## ⚡ 五、性能优化

### 5.1 邀请码生成优化
- 使用Redis缓存已生成的邀请码
- 避免重复生成（同一个babyId，未过期则不重新生成）

### 5.2 数据同步优化
- 增量同步（只同步变更数据）
- 批量推送（多个操作合并推送）
- 冲突解决（时间戳优先）

---

**文档版本：** v1.0  
**创建时间：** 2025年1月

