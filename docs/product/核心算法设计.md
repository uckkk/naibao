# æ ¸å¿ƒç®—æ³•å®ç°è®¾è®¡

## ğŸ§® ä¸€ã€å¥¶é‡è®¡ç®—ç®—æ³•

### 1.1 æ ¸å¿ƒè®¡ç®—å…¬å¼

```typescript
// å¥¶é‡è®¡ç®—æ ¸å¿ƒç®—æ³•
interface BabyInfo {
  weight: number;        // ä½“é‡ï¼ˆkgï¼‰
  age: number;           // æœˆé¾„ï¼ˆæœˆï¼‰
  birthDate: Date;       // å‡ºç”Ÿæ—¥æœŸ
}

interface FeedingRecord {
  time: Date;            // å–‚å…»æ—¶é—´
  amount: number;        // å¥¶é‡ï¼ˆmlï¼‰
}

interface RecommendedAmount {
  recommended: number;   // æ¨èå¥¶é‡
  dailyStandard: number;  // æ—¥å‡æ ‡å‡†é‡
  dailyConsumed: number; // ä»Šæ—¥å·²æ‘„å…¥
  remainingTimes: number; // å‰©ä½™å–‚å…»æ¬¡æ•°
  warning?: 'normal' | 'low' | 'high'; // é¢„è­¦çŠ¶æ€
  ageReference: string;  // æœˆé¾„å‚è€ƒèŒƒå›´
}

/**
 * è®¡ç®—æ ‡å‡†æ—¥å‡å¥¶é‡ï¼ˆæŒ‰ä½“é‡ï¼‰
 */
/**
 * è®¡ç®—æ ‡å‡†æ—¥å‡å¥¶é‡ï¼ˆæŒ‰ä½“é‡ï¼‰- å«å¥å§”2025æ ‡å‡†
 */
function calculateDailyStandard(weight: number): number {
  // å«å¥å§”2025æ ‡å‡†ï¼šæ¯å…¬æ–¤ä½“é‡120-150ml/å¤©
  const minCoefficient = 120;  // ml/kg/å¤©ï¼ˆæœ€å°å€¼ï¼‰
  const maxCoefficient = 150;  // ml/kg/å¤©ï¼ˆæœ€å¤§å€¼ï¼‰
  const recommendedCoefficient = 135; // ml/kg/å¤©ï¼ˆæ¨èå€¼ï¼Œå–ä¸­é—´å€¼ï¼‰
  
  return weight * recommendedCoefficient;
}

/**
 * è·å–æœˆé¾„å‚è€ƒèŒƒå›´ï¼ˆå«å¥å§”2025æ ‡å‡†ï¼‰
 * æ•°æ®æ¥æºï¼šã€Šå©´å¹¼å„¿è¥å…»å–‚å…»è¯„ä¼°æœåŠ¡æŒ‡å—ï¼ˆè¯•è¡Œï¼‰ã€‹
 */
function getAgeReference(age: number): { min: number; max: number; text: string } {
  if (age < 1) {
    // 0-1ä¸ªæœˆï¼š600-700ml/å¤©
    return { min: 600, max: 700, text: '600-700ml/å¤©' };
  } else if (age < 3) {
    // 1-3ä¸ªæœˆï¼š700-900ml/å¤©
    return { min: 700, max: 900, text: '700-900ml/å¤©' };
  } else if (age < 6) {
    // 3-6ä¸ªæœˆï¼š800-1000ml/å¤©
    return { min: 800, max: 1000, text: '800-1000ml/å¤©' };
  } else {
    // 6-12ä¸ªæœˆï¼š900-1100ml/å¤©
    return { min: 900, max: 1100, text: '900-1100ml/å¤©' };
  }
}

/**
 * è®¡ç®—ä»Šæ—¥å‰©ä½™å–‚å…»æ¬¡æ•°
 */
function calculateRemainingFeedingTimes(
  currentTime: Date,
  dayStartTime: number = 6,  // æ—©ä¸Š6ç‚¹
  dayEndTime: number = 18,   // æ™šä¸Š18ç‚¹
  dayInterval: number = 3,   // ç™½å¤©é—´éš”3å°æ—¶
  nightInterval: number = 5  // æ™šä¸Šé—´éš”5å°æ—¶
): number {
  const hour = currentTime.getHours();
  const minutes = currentTime.getMinutes();
  const currentMinutes = hour * 60 + minutes;
  
  let remainingTimes = 0;
  
  if (hour >= dayStartTime && hour < dayEndTime) {
    // ç™½å¤©æ—¶æ®µ
    const dayEndMinutes = dayEndTime * 60;
    const remainingMinutes = dayEndMinutes - currentMinutes;
    remainingTimes = Math.floor(remainingMinutes / (dayInterval * 60));
    
    // åŠ ä¸Šæ™šä¸Šæ—¶æ®µ
    const nightStartMinutes = dayEndTime * 60;
    const nightEndMinutes = (24 + dayStartTime) * 60;
    const nightMinutes = nightEndMinutes - nightStartMinutes;
    remainingTimes += Math.floor(nightMinutes / (nightInterval * 60));
  } else {
    // æ™šä¸Šæ—¶æ®µ
    const dayStartMinutes = (24 + dayStartTime) * 60;
    const remainingMinutes = dayStartMinutes - currentMinutes;
    remainingTimes = Math.floor(remainingMinutes / (nightInterval * 60));
  }
  
  return Math.max(1, remainingTimes); // è‡³å°‘1æ¬¡
}

/**
 * è·å–ç”¨æˆ·åå¥½å¥¶é‡ï¼ˆè®°å¿†åŠŸèƒ½ï¼‰
 */
function getUserPreference(userId: string, recentFeedings: FeedingRecord[]): number | null {
  if (recentFeedings.length === 0) return null;
  
  // å–æœ€è¿‘10æ¬¡å–‚å…»è®°å½•
  const recent = recentFeedings.slice(-10);
  
  // å¦‚æœæœ€è¿‘3æ¬¡éƒ½æ˜¯ç›¸åŒå€¼ï¼Œè¿”å›è¯¥å€¼
  const last3 = recent.slice(-3).map(r => r.amount);
  if (last3.length === 3 && last3[0] === last3[1] && last3[1] === last3[2]) {
    return last3[0];
  }
  
  // å¦åˆ™è¿”å›å¹³å‡å€¼
  const sum = recent.reduce((acc, r) => acc + r.amount, 0);
  return Math.round(sum / recent.length);
}

/**
 * ä¸»å‡½æ•°ï¼šè®¡ç®—æ¨èå¥¶é‡
 */
function calculateRecommendedAmount(
  baby: BabyInfo,
  todayFeedings: FeedingRecord[],
  userPreference: number | null,
  currentTime: Date = new Date()
): RecommendedAmount {
  // 1. è®¡ç®—æ ‡å‡†æ—¥å‡å¥¶é‡ï¼ˆæŒ‰ä½“é‡ï¼‰
  const dailyStandard = calculateDailyStandard(baby.weight);
  
  // 2. è·å–æœˆé¾„å‚è€ƒèŒƒå›´
  const ageReference = getAgeReference(baby.age);
  
  // 3. è®¡ç®—ä»Šæ—¥å·²æ‘„å…¥é‡
  const today = new Date(currentTime.getFullYear(), currentTime.getMonth(), currentTime.getDate());
  const dailyConsumed = todayFeedings
    .filter(f => {
      const feedingDate = new Date(f.time);
      return feedingDate >= today && feedingDate < new Date(today.getTime() + 24 * 60 * 60 * 1000);
    })
    .reduce((sum, f) => sum + f.amount, 0);
  
  // 4. è®¡ç®—å‰©ä½™å–‚å…»æ¬¡æ•°
  const remainingTimes = calculateRemainingFeedingTimes(currentTime);
  
  // 5. è®¡ç®—å‰©ä½™æ ‡å‡†é‡
  const remainingStandard = dailyStandard - dailyConsumed;
  
  // 6. è®¡ç®—å•æ¬¡æ¨èé‡
  let recommended: number;
  
  if (remainingTimes > 0 && remainingStandard > 0) {
    // åŸºäºå‰©ä½™æ ‡å‡†é‡è®¡ç®—
    recommended = remainingStandard / remainingTimes;
    
    // é™åˆ¶èŒƒå›´ï¼š50-200ml
    recommended = Math.max(50, Math.min(200, Math.round(recommended)));
  } else {
    // ä½¿ç”¨ç”¨æˆ·åå¥½æˆ–é»˜è®¤å€¼
    if (userPreference) {
      recommended = userPreference;
    } else {
      // é»˜è®¤ï¼šæ—¥å‡æ ‡å‡† Ã· å¹³å‡å–‚å…»æ¬¡æ•°ï¼ˆå‡è®¾ä¸€å¤©6æ¬¡ï¼‰
      recommended = Math.round(dailyStandard / 6);
    }
  }
  
  // 7. é¢„è­¦åˆ¤æ–­
  const warningRatio = dailyConsumed / dailyStandard;
  let warning: 'normal' | 'low' | 'high' = 'normal';
  
  if (warningRatio > 1.2) {
    warning = 'high';
  } else if (warningRatio < 0.8) {
    warning = 'low';
  }
  
  return {
    recommended,
    dailyStandard: Math.round(dailyStandard),
    dailyConsumed,
    remainingTimes,
    warning,
    ageReference: ageReference.text
  };
}

// ä½¿ç”¨ç¤ºä¾‹
// ç¤ºä¾‹ï¼š3ä¸ªæœˆå®å®ï¼ˆæ ‡å‡†æ•°æ®ï¼‰
const baby: BabyInfo = {
  weight: 6.0,  // 3ä¸ªæœˆæ ‡å‡†ä½“é‡ï¼ˆå«å¥å§”æ ‡å‡†ï¼‰
  age: 3,       // 3ä¸ªæœˆ
  birthDate: new Date('2024-08-28')
};

const todayFeedings: FeedingRecord[] = [
  { time: new Date('2024-11-15T06:00:00'), amount: 150 },
  { time: new Date('2024-11-15T09:30:00'), amount: 140 },
  { time: new Date('2024-11-15T12:45:00'), amount: 150 }
];

const result = calculateRecommendedAmount(
  baby,
  todayFeedings,
  150,  // ç”¨æˆ·åå¥½
  new Date('2024-11-15T15:00:00')  // å½“å‰æ—¶é—´ï¼šä¸‹åˆ3ç‚¹
);

console.log(result);
// è¾“å‡ºï¼š
// {
//   recommended: 130,
//   dailyStandard: 810,  // 6.0kg Ã— 135ml/kg = 810ml/å¤©
//   dailyConsumed: 440,
//   remainingTimes: 4,
//   warning: 'low',      // 440/810 = 54% < 80%ï¼Œåä½é¢„è­¦
//   ageReference: '700-900ml/å¤©'  // 1-3ä¸ªæœˆå«å¥å§”æ ‡å‡†èŒƒå›´
// }
```

---

## ğŸ’¾ äºŒã€ç”¨æˆ·åå¥½è®°å¿†ç®—æ³•

### 2.1 åå¥½æ•°æ®ç»“æ„

```typescript
interface UserPreference {
  userId: string;
  babyId: string;
  defaultAmount: number;        // é»˜è®¤å¥¶é‡
  adjustmentPattern: number;    // è°ƒæ•´æ¨¡å¼ï¼ˆå¦‚ï¼šæ€»æ˜¯+20mlï¼‰
  inputMethod: 'direct' | 'quick' | 'manual';  // è¾“å…¥æ–¹å¼åå¥½
  lastUpdated: Date;
}

/**
 * æ›´æ–°ç”¨æˆ·åå¥½
 */
function updateUserPreference(
  userId: string,
  babyId: string,
  recentFeedings: FeedingRecord[],
  recentAdjustments: { recommended: number; actual: number }[]
): UserPreference {
  // 1. è®¡ç®—é»˜è®¤å¥¶é‡åå¥½
  const amounts = recentFeedings.slice(-10).map(f => f.amount);
  const defaultAmount = Math.round(amounts.reduce((a, b) => a + b, 0) / amounts.length);
  
  // 2. æ£€æŸ¥æ˜¯å¦è¿ç»­3æ¬¡ç›¸åŒ
  if (amounts.length >= 3) {
    const last3 = amounts.slice(-3);
    if (last3[0] === last3[1] && last3[1] === last3[2]) {
      return {
        userId,
        babyId,
        defaultAmount: last3[0],
        adjustmentPattern: 0,
        inputMethod: 'direct',
        lastUpdated: new Date()
      };
    }
  }
  
  // 3. è®¡ç®—è°ƒæ•´æ¨¡å¼
  let adjustmentPattern = 0;
  if (recentAdjustments.length > 0) {
    const adjustments = recentAdjustments
      .slice(-10)
      .map(a => a.actual - a.recommended);
    const avgAdjustment = adjustments.reduce((a, b) => a + b, 0) / adjustments.length;
    
    // å¦‚æœç”¨æˆ·æ€»æ˜¯è°ƒæ•´ç›¸åŒçš„é‡ï¼ˆÂ±5mlè¯¯å·®èŒƒå›´å†…ï¼‰ï¼Œè®°å½•è¯¥æ¨¡å¼
    if (Math.abs(avgAdjustment) > 5) {
      adjustmentPattern = Math.round(avgAdjustment / 10) * 10; // å››èˆäº”å…¥åˆ°10çš„å€æ•°
    }
  }
  
  // 4. åˆ¤æ–­è¾“å…¥æ–¹å¼åå¥½ï¼ˆéœ€è¦è®°å½•ç”¨æˆ·çš„è¾“å…¥æ–¹å¼ï¼‰
  // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦è®°å½•ç”¨æˆ·æ¯æ¬¡é€‰æ‹©çš„è¾“å…¥æ–¹å¼
  
  return {
    userId,
    babyId,
    defaultAmount,
    adjustmentPattern,
    inputMethod: 'quick', // é»˜è®¤
    lastUpdated: new Date()
  };
}

/**
 * åº”ç”¨ç”¨æˆ·åå¥½åˆ°æ¨èå€¼
 */
function applyUserPreference(
  recommended: number,
  preference: UserPreference | null
): number {
  if (!preference) return recommended;
  
  // å¦‚æœç”¨æˆ·æœ‰è°ƒæ•´æ¨¡å¼ï¼Œåº”ç”¨è°ƒæ•´
  if (preference.adjustmentPattern !== 0) {
    return recommended + preference.adjustmentPattern;
  }
  
  // å¦‚æœç”¨æˆ·æœ‰é»˜è®¤åå¥½ï¼Œä¸”æ¨èå€¼æ¥è¿‘ï¼Œä½¿ç”¨åå¥½å€¼
  if (Math.abs(recommended - preference.defaultAmount) <= 20) {
    return preference.defaultAmount;
  }
  
  return recommended;
}
```

---

## ğŸ”„ ä¸‰ã€å®æ—¶åŒæ­¥ç®—æ³•

### 3.1 æ•°æ®ç‰ˆæœ¬æ§åˆ¶

```typescript
interface DataEntity {
  id: string;
  userId: string;
  deviceId: string;
  timestamp: number;      // æœåŠ¡å™¨æ—¶é—´æˆ³
  localTimestamp: number;  // æœ¬åœ°æ—¶é—´æˆ³
  version: number;         // ç‰ˆæœ¬å·ï¼ˆä¹è§‚é”ï¼‰
  operation: 'create' | 'update' | 'delete';
  data: any;
}

/**
 * å†²çªè§£å†³ï¼šæ—¶é—´æˆ³ä¼˜å…ˆ + ç‰ˆæœ¬å·æ§åˆ¶
 */
function resolveConflict(
  localData: DataEntity,
  serverData: DataEntity
): DataEntity {
  // 1. ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨æ—¶é—´æˆ³ï¼ˆæœåŠ¡å™¨æ˜¯æƒå¨ï¼‰
  if (serverData.timestamp > localData.timestamp) {
    return serverData;
  }
  
  // 2. å¦‚æœæ—¶é—´æˆ³ç›¸åŒï¼Œæ£€æŸ¥ç‰ˆæœ¬å·
  if (serverData.timestamp === localData.timestamp) {
    if (serverData.version > localData.version) {
      return serverData;
    }
  }
  
  // 3. å¦‚æœæ˜¯åˆ é™¤æ“ä½œï¼Œä¼˜å…ˆåˆ é™¤
  if (serverData.operation === 'delete') {
    return serverData;
  }
  
  // 4. åˆå¹¶ç­–ç•¥ï¼šç›¸åŒæ“ä½œåˆå¹¶ï¼ˆå¦‚ï¼šåŒæ—¶å¢åŠ å¥¶é‡ï¼Œç´¯åŠ ï¼‰
  if (localData.operation === 'update' && serverData.operation === 'update') {
    if (localData.data.type === 'feeding' && serverData.data.type === 'feeding') {
      // å–‚å…»è®°å½•ï¼šå¦‚æœæ˜¯åŒä¸€æ¡è®°å½•çš„ä¸åŒå­—æ®µæ›´æ–°ï¼Œåˆå¹¶
      return {
        ...serverData,
        data: { ...serverData.data, ...localData.data },
        version: Math.max(serverData.version, localData.version) + 1
      };
    }
  }
  
  // 5. é»˜è®¤ï¼šæœåŠ¡å™¨ä¼˜å…ˆ
  return serverData;
}
```

### 3.2 å¢é‡åŒæ­¥

```typescript
/**
 * å¢é‡åŒæ­¥ï¼šåªåŒæ­¥å˜æ›´çš„æ•°æ®
 */
function syncIncremental(
  lastSyncTime: number,
  localChanges: DataEntity[],
  serverChanges: DataEntity[]
): {
  toUpload: DataEntity[];
  toDownload: DataEntity[];
} {
  // 1. è¿‡æ»¤å‡ºéœ€è¦ä¸Šä¼ çš„æœ¬åœ°å˜æ›´
  const toUpload = localChanges.filter(c => c.localTimestamp > lastSyncTime);
  
  // 2. è¿‡æ»¤å‡ºéœ€è¦ä¸‹è½½çš„æœåŠ¡å™¨å˜æ›´
  const toDownload = serverChanges.filter(c => c.timestamp > lastSyncTime);
  
  return { toUpload, toDownload };
}
```

---

## ğŸ“Š å››ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 4.1 æœ¬åœ°ç¼“å­˜ç­–ç•¥

```typescript
interface CacheConfig {
  ttl: number;  // ç¼“å­˜æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  maxSize: number;  // æœ€å¤§ç¼“å­˜æ•°é‡
}

const cacheConfig: Record<string, CacheConfig> = {
  'recommendedAmount': { ttl: 60 * 60 * 1000, maxSize: 10 },  // 1å°æ—¶ï¼Œæœ€å¤š10æ¡
  'dailyStatistics': { ttl: 5 * 60 * 1000, maxSize: 30 },      // 5åˆ†é’Ÿï¼Œ30å¤©
  'userPreference': { ttl: 24 * 60 * 60 * 1000, maxSize: 1 }   // 24å°æ—¶ï¼Œ1æ¡
};

/**
 * è·å–ç¼“å­˜æ•°æ®
 */
function getCachedData<T>(key: string, calculateFn: () => T): T {
  const cached = localStorage.getItem(`cache_${key}`);
  if (cached) {
    const { data, timestamp } = JSON.parse(cached);
    const config = cacheConfig[key];
    
    if (Date.now() - timestamp < config.ttl) {
      return data;
    }
  }
  
  // è®¡ç®—æ–°æ•°æ®
  const data = calculateFn();
  
  // ä¿å­˜ç¼“å­˜
  localStorage.setItem(`cache_${key}`, JSON.stringify({
    data,
    timestamp: Date.now()
  }));
  
  return data;
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¶é—´**ï¼š2025å¹´1æœˆ

