<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å¿«é€Ÿæµ‹è¯•</title>
</head>
<body>
    <h1>APIè¿æ¥å¿«é€Ÿæµ‹è¯•</h1>
    <button onclick="test()">æµ‹è¯•æ³¨å†Œæ¥å£</button>
    <pre id="result"></pre>
    
    <script>
        async function test() {
            const result = document.getElementById('result')
            const params = new URLSearchParams(window.location.search)
            const API_BASE = params.get('api') || window.location.origin

            let log = 'å¼€å§‹æµ‹è¯•...\n\n'
            log += `API_BASE: ${API_BASE}\n\n`
            result.textContent = log
            
            try {
                // 1. æµ‹è¯•å¥åº·æ£€æŸ¥
                log += '1. æµ‹è¯•å¥åº·æ£€æŸ¥æ¥å£...\n'
                result.textContent = log
                
                try {
                    const healthResponse = await fetch(`${API_BASE}/health`, {
                        method: 'GET',
                        mode: 'cors'
                    })
                    log += `   çŠ¶æ€ç : ${healthResponse.status}\n`
                    const healthData = await healthResponse.json()
                    log += `   å“åº”: ${JSON.stringify(healthData)}\n\n`
                    result.textContent = log
                } catch (e) {
                    log += `   âŒ å¥åº·æ£€æŸ¥å¤±è´¥: ${e.message}\n\n`
                    result.textContent = log
                }
                
                // 2. æµ‹è¯•æ³¨å†Œæ¥å£
                log += '2. æµ‹è¯•æ³¨å†Œæ¥å£...\n'
                result.textContent = log
                
                const phone = '189' + Math.floor(Math.random() * 100000000).toString().padStart(8, '0')
                log += `   æ‰‹æœºå·: ${phone}\n`
                result.textContent = log
                
                const startTime = Date.now()
                const response = await fetch(`${API_BASE}/api/public/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        phone: phone,
                        password: 'test123456',
                        nickname: 'æµ‹è¯•ç”¨æˆ·'
                    })
                })
                
                const endTime = Date.now()
                log += `   å“åº”æ—¶é—´: ${endTime - startTime}ms\n`
                log += `   çŠ¶æ€ç : ${response.status}\n`
                log += `   Status Text: ${response.statusText}\n`
                
                // æ£€æŸ¥å“åº”å¤´
                log += `   å“åº”å¤´:\n`
                response.headers.forEach((value, key) => {
                    log += `     ${key}: ${value}\n`
                })
                
                result.textContent = log
                
                const data = await response.json()
                log += `\nå“åº”æ•°æ®:\n${JSON.stringify(data, null, 2)}\n`
                
                if (response.ok) {
                    log += `\nâœ… æ³¨å†ŒæˆåŠŸï¼`
                } else {
                    log += `\nâš ï¸ æ³¨å†Œå¤±è´¥ï¼ˆçŠ¶æ€ç : ${response.status}ï¼‰`
                }
                
                result.textContent = log
            } catch (error) {
                log += `\nâŒ é”™è¯¯è¯¦æƒ…:\n`
                log += `   é”™è¯¯ç±»å‹: ${error.name}\n`
                log += `   é”™è¯¯æ¶ˆæ¯: ${error.message}\n`
                log += `   é”™è¯¯å †æ ˆ:\n${error.stack}\n`
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œé”™è¯¯
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    log += `\nğŸ’¡ è¿™å¯èƒ½æ˜¯ç½‘ç»œè¿æ¥é—®é¢˜æˆ–CORSé—®é¢˜\n`
                }
                
                result.textContent = log
                console.error('å®Œæ•´é”™è¯¯:', error)
            }
        }
    </script>
</body>
</html>
