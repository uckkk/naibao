<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 10px 5px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>ğŸ”— æœåŠ¡å™¨è¿æ¥æµ‹è¯•</h1>
    <button onclick="testHealth()">æµ‹è¯•å¥åº·æ£€æŸ¥</button>
    <button onclick="testRegister()">æµ‹è¯•æ³¨å†Œæ¥å£</button>
    <div id="result" class="result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const API_BASE = params.get('api') || window.location.origin;
        
        function showResult(message, isError = false) {
            const result = document.getElementById('result');
            result.textContent = message;
            result.className = 'result ' + (isError ? 'error' : 'success');
        }
        
        async function testHealth() {
            showResult('æµ‹è¯•ä¸­...\n\næ­£åœ¨è¿æ¥æœåŠ¡å™¨...');
            const start = Date.now();
            
            try {
                // å…ˆæµ‹è¯•åŸºæœ¬è¿æ¥
                showResult('æµ‹è¯•ä¸­...\n\næ­¥éª¤1: æµ‹è¯•åŸºæœ¬è¿æ¥...');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ—¶
                
                const response = await fetch(`${API_BASE}/health`, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const time = Date.now() - start;
                
                showResult(`âœ… è¿æ¥æˆåŠŸï¼\n\næ­¥éª¤2: è§£æå“åº”...`);
                
                const data = await response.json();
                
                const headers = [];
                response.headers.forEach((value, key) => {
                    headers.push(`${key}: ${value}`);
                });
                
                showResult(`âœ… å¥åº·æ£€æŸ¥æˆåŠŸï¼\n\nçŠ¶æ€ç : ${response.status}\nå“åº”æ—¶é—´: ${time}ms\n\nå“åº”æ•°æ®:\n${JSON.stringify(data, null, 2)}\n\nå“åº”å¤´:\n${headers.join('\n')}`);
            } catch (error) {
                const time = Date.now() - start;
                let errorDetails = `âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼\n\n`;
                errorDetails += `é”™è¯¯ç±»å‹: ${error.name}\n`;
                errorDetails += `é”™è¯¯æ¶ˆæ¯: ${error.message}\n`;
                errorDetails += `è€—æ—¶: ${time}ms\n\n`;
                
                if (error.name === 'AbortError') {
                    errorDetails += `ğŸ’¡ åŸå› : è¯·æ±‚è¶…æ—¶ï¼ˆ10ç§’ï¼‰\n`;
                    errorDetails += `å¯èƒ½åŸå› ï¼š\n`;
                    errorDetails += `1. è…¾è®¯äº‘å®‰å…¨ç»„æœªå¼€æ”¾8080ç«¯å£\n`;
                    errorDetails += `2. æœåŠ¡å™¨é˜²ç«å¢™é˜»æ­¢\n`;
                    errorDetails += `3. ç½‘ç»œè·¯ç”±é—®é¢˜\n`;
                } else if (error.message.includes('Failed to fetch')) {
                    errorDetails += `ğŸ’¡ åŸå› : æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨\n`;
                    errorDetails += `å¯èƒ½åŸå› ï¼š\n`;
                    errorDetails += `1. âš ï¸  è…¾è®¯äº‘å®‰å…¨ç»„æœªå¼€æ”¾8080ç«¯å£ï¼ˆæœ€å¯èƒ½ï¼‰\n`;
                    errorDetails += `2. æœåŠ¡å™¨é˜²ç«å¢™é˜»æ­¢\n`;
                    errorDetails += `3. ç½‘ç»œè¿æ¥é—®é¢˜\n`;
                    errorDetails += `4. CORSé¢„æ£€è¯·æ±‚å¤±è´¥\n\n`;
                    errorDetails += `ğŸ”§ è§£å†³æ–¹æ¡ˆï¼š\n`;
                    errorDetails += `1. ç™»å½•è…¾è®¯äº‘æ§åˆ¶å°\n`;
                    errorDetails += `2. äº‘æœåŠ¡å™¨ â†’ å®ä¾‹ â†’ æ‰¾åˆ°æ‚¨çš„æœåŠ¡å™¨\n`;
                    errorDetails += `3. ç‚¹å‡»ã€Œå®‰å…¨ç»„ã€æ ‡ç­¾\n`;
                    errorDetails += `4. ç‚¹å‡»å®‰å…¨ç»„åç§°\n`;
                    errorDetails += `5. ã€Œå…¥ç«™è§„åˆ™ã€â†’ã€Œæ·»åŠ è§„åˆ™ã€\n`;
                    errorDetails += `6. ç±»å‹ï¼šè‡ªå®šä¹‰ï¼Œæ¥æºï¼š0.0.0.0/0ï¼Œåè®®ç«¯å£ï¼šTCP:8080ï¼Œç­–ç•¥ï¼šå…è®¸\n`;
                    errorDetails += `7. ç‚¹å‡»ã€Œå®Œæˆã€å¹¶ç­‰å¾…1-2åˆ†é’Ÿ\n`;
                } else {
                    errorDetails += `é”™è¯¯å †æ ˆ:\n${error.stack}`;
                }
                
                showResult(errorDetails, true);
            }
        }
        
        async function testRegister() {
            showResult('æµ‹è¯•ä¸­...\n\næ­£åœ¨æµ‹è¯•æ³¨å†Œæ¥å£...');
            try {
                const phone = '189' + Math.floor(Math.random() * 100000000).toString().padStart(8, '0');
                const start = Date.now();
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(`${API_BASE}/api/public/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    cache: 'no-cache',
                    signal: controller.signal,
                    body: JSON.stringify({
                        phone: phone,
                        password: 'test123456',
                        nickname: 'æµ‹è¯•ç”¨æˆ·'
                    })
                });
                
                clearTimeout(timeoutId);
                const time = Date.now() - start;
                const data = await response.json();
                
                if (response.ok) {
                    showResult(`âœ… æ³¨å†ŒæˆåŠŸï¼\n\næ‰‹æœºå·: ${phone}\nçŠ¶æ€ç : ${response.status}\nå“åº”æ—¶é—´: ${time}ms\n\nå“åº”æ•°æ®:\n${JSON.stringify(data, null, 2)}\n\nâœ… Token: ${data.token ? 'å·²ç”Ÿæˆ' : 'æœªç”Ÿæˆ'}\nâœ… ç”¨æˆ·ID: ${data.user?.id || 'N/A'}`);
                } else {
                    showResult(`âš ï¸ æ³¨å†Œå¤±è´¥\n\nçŠ¶æ€ç : ${response.status}\nå“åº”æ—¶é—´: ${time}ms\n\nå“åº”æ•°æ®:\n${JSON.stringify(data, null, 2)}`, true);
                }
            } catch (error) {
                const time = Date.now() - start;
                let errorDetails = `âŒ æ³¨å†Œå¤±è´¥ï¼\n\n`;
                errorDetails += `é”™è¯¯ç±»å‹: ${error.name}\n`;
                errorDetails += `é”™è¯¯æ¶ˆæ¯: ${error.message}\n`;
                errorDetails += `è€—æ—¶: ${time}ms\n\n`;
                
                if (error.name === 'AbortError') {
                    errorDetails += `ğŸ’¡ åŸå› : è¯·æ±‚è¶…æ—¶ï¼ˆ10ç§’ï¼‰`;
                } else {
                    errorDetails += `é”™è¯¯å †æ ˆ:\n${error.stack}`;
                }
                
                showResult(errorDetails, true);
            }
        }
    </script>
</body>
</html>
