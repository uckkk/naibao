# 网络连接问题排查指南

## 当前问题
前端请求后端API时出现超时错误：`request:fail timeout`

## 排查步骤

### 1. 检查服务器是否正常运行
```bash
# 检查进程
ssh -p <SSH_PORT> <SSH_USER>@<SSH_HOST> "ps aux | grep naibao-server"

# 检查端口监听
ssh -p <SSH_PORT> <SSH_USER>@<SSH_HOST> "netstat -tlnp | grep 8080"

# 检查日志
ssh -p <SSH_PORT> <SSH_USER>@<SSH_HOST> "tail -20 /opt/naibao/backend/server.log"
```

### 2. 检查防火墙和安全组
- **腾讯云控制台** → **云服务器** → **安全组**
- 确保入站规则允许 TCP 8080 端口
- 源地址设置为 `0.0.0.0/0`（允许所有IP访问）

### 3. 测试网络连接

#### 从本地测试
```bash
# 测试健康检查接口
curl -v http://<API_HOST>:8080/health --max-time 10

# 测试注册接口
curl -X POST http://<API_HOST>:8080/api/public/register \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","password":"123456"}' \
  -v --max-time 10
```

#### 从浏览器测试
打开浏览器控制台，执行：
```javascript
fetch('http://<API_HOST>:8080/health')
  .then(r => r.json())
  .then(console.log)
  .catch(console.error)
```

### 4. 检查CORS配置
后端CORS配置在 `backend/router/middleware/cors.go`，已配置为允许所有来源：
- `Access-Control-Allow-Origin: *`
- 已处理OPTIONS预检请求

### 5. 可能的原因和解决方案

#### 原因1：服务器只监听IPv6
如果 `netstat` 显示 `:::8080`，服务器监听IPv6。虽然通常能处理IPv4请求，但可能有问题。

**解决方案**：确保服务器监听 `0.0.0.0:8080`（IPv4）或 `[::]:8080`（IPv6和IPv4）

#### 原因2：网络路由问题
本地网络可能无法访问服务器IP。

**解决方案**：
- 检查本地网络设置
- 尝试使用VPN或代理
- 检查是否有防火墙阻止

#### 原因3：浏览器CORS预检请求失败
浏览器发送OPTIONS预检请求时超时。

**解决方案**：
- 检查浏览器控制台的Network标签
- 查看OPTIONS请求是否成功
- 检查响应头是否正确

### 6. 临时解决方案（开发测试）

如果需要本地/测试环境切换 API 地址，建议通过环境变量配置，而不是改代码：

```bash
# 复制示例并修改（不提交）
cp frontend/.env.example frontend/.env.local
$EDITOR frontend/.env.local

# 例如本地后端
# VITE_API_BASE_URL=http://localhost:8080
```

然后在本地启动前端/后端服务进行测试。

### 7. 调试信息

前端已添加详细的调试日志：
- `[API请求]` - 显示请求信息
- `[API响应]` - 显示响应信息
- `[API失败]` - 显示失败信息
- `[XHR错误]` - 显示XMLHttpRequest错误
- `[XHR超时]` - 显示超时信息

打开浏览器控制台查看详细日志。

## 下一步
1. 检查服务器状态和端口监听
2. 验证防火墙和安全组设置
3. 测试网络连接
4. 查看浏览器Network标签中的请求详情

